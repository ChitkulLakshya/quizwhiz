/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a role-based access control model for a real-time quiz application.
 *
 * Data Structure:
 * - /quizzes/{quizId}: Stores quiz metadata.
 * - /quizzes/{quizId}/questions/{questionId}: Stores questions for a quiz.
 * - /quizzes/{quizId}/participants/{participantId}: Stores participant information for a quiz.
 * - /quizzes/{quizId}/participants/{participantId}/scores/{scoreId}: Stores scores for a participant in a quiz.
 * - /roles_admin/{userId}: Stores admin users. Document existence implies admin role.
 *
 * Key Security Decisions:
 * - Admins (defined in /roles_admin/{userId}) have full access to quizzes, questions, participants, and scores.
 * - Participants can only manage their own participant documents and scores.
 * - Read access to quizzes and questions is generally open.
 * - Listing of participants and scores is restricted to admins.
 *
 * Denormalization for Authorization:
 * - The `quizId` is denormalized into the `Question`, `Participant`, and `Score` documents to avoid needing to make extra `get()` calls to the `/quizzes/{quizId}` document.
 *
 * Structural Segregation:
 * - Admin roles are stored in a separate collection (`/roles_admin/{userId}`) to prevent exposure through listing operations.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows admins to manage quizzes.
     * @path /quizzes/{quizId}
     * @allow (create) Admin user creates a new quiz document.
     * @deny (create) Non-admin user attempts to create a quiz.
     * @allow (get, list) Any user can read quiz metadata.
     * @deny (update, delete) Non-admin user attempts to modify/delete a quiz.
     * @principle Role-based access control for quiz management.
     */
    match /quizzes/{quizId} {
      allow get, list: if true;
      allow create: if isAdmin();
      allow update, delete: if isAdmin();
    }

    /**
     * @description Allows admins to manage questions for a quiz.
     * @path /quizzes/{quizId}/questions/{questionId}
     * @allow (create) Admin user creates a question.
     * @deny (create) Non-admin user attempts to create a question.
     * @allow (get, list) Any user can read questions.
     * @deny (update, delete) Non-admin user attempts to modify/delete a question.
     * @principle Role-based access control for question management.
     */
    match /quizzes/{quizId}/questions/{questionId} {
      allow get, list: if true;
      allow create: if isAdmin();
      allow update, delete: if isAdmin();
    }

    /**
     * @description Allows participants to manage their own participant document within a quiz.
     * @path /quizzes/{quizId}/participants/{participantId}
     * @allow (create) Any authenticated user creates a participant document with their own ID.
     * @deny (create) User attempts to create a participant document with a mismatched ID.
     * @allow (get) Any authenticated user can read their participant data.
     * @deny (list) Listing participants is forbidden for non-admins.
     * @allow (update, delete) The participant can update/delete their own document.
     * @principle Enforces document ownership and restricts listing to admins.
     */
    match /quizzes/{quizId}/participants/{participantId} {
      allow create: if isSignedIn() && request.auth.uid == participantId;
      allow get: if isSignedIn() && request.auth.uid == participantId;
      allow list: if isAdmin();
      allow update, delete: if isSignedIn() && request.auth.uid == participantId;
    }

    /**
     * @description Allows participants to manage their own scores for a quiz.
     * @path /quizzes/{quizId}/participants/{participantId}/scores/{scoreId}
     * @allow (create) Any authenticated user can create a score document under their participant ID.
     * @deny (create) User attempts to create a score document under a mismatched participant ID.
     * @allow (get) Any authenticated user can read their own score data.
     * @deny (list) Listing scores is forbidden for non-admins.
     * @allow (update, delete) The participant can update/delete their own score document.
     * @principle Enforces document ownership and restricts listing to admins.
     */
    match /quizzes/{quizId}/participants/{participantId}/scores/{scoreId} {
      allow create: if isSignedIn() && request.auth.uid == participantId;
      allow get: if isSignedIn() && request.auth.uid == participantId;
      allow list: if isAdmin();
      allow update, delete: if isSignedIn() && request.auth.uid == participantId;
    }

    /**
     * @description Defines admin users. Existence of a document grants admin privileges.
     * @path /roles_admin/{userId}
     * @allow (create) Only callable through firebase admin sdk, not through client code.
     * @allow (get) Only admins can verify the existence of other admins.
     * @deny (list) Listing admin roles is forbidden.
     * @allow (update, delete) Only callable through firebase admin sdk, not through client code.
     * @principle Role-based access control for admin privileges.
     */
    match /roles_admin/{userId} {
        allow get: if isAdmin();
        allow list: if false;
        allow create, update, delete: if false; // Only manageable via Admin SDK
    }

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }
  }
}